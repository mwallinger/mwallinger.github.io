<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>InfoViz SS 2016</title>
  <meta name="description" content="Information Visualization Course SS 2016">
  <meta name="author" content="Markus Wallinger">

  <link rel="stylesheet" href="css/metricsgraphics.css">
  <link rel="stylesheet" href="css/iThing-min.css">
  <link href="lib/noUiSlider/nouislider.min.css" rel="stylesheet">
  <script src="lib/jquery-3.0.0.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script> 
  <script src="lib/metricsGraphics/metricsgraphics.js"></script>
  <script src="lib/noUiSlider/wNumb.js"></script>
  <script src="lib/d3-tip.js"></script>
  <script src="scripts.js"></script>
  


</head>
<style>
    html, body, #map {
      width: 100%;
      height: 400px;
      margin: 0;
      padding: 0;
    }
    
    .stations, .stations svg {
      position: absolute;
    }
    .stations svg {
      width: 60px;
      height: 20px;
      padding-right: 100px;
      font: 10px sans-serif;
    }
    .stations circle {
      fill: brown;
      stroke: black;
      stroke-width: 1.5px;
    }
    
    #slider-date {
        height: 20px;
        width: auto;
        display: block;
    }
    
    .sliderDiv {
        height: 50px;
        width: 98%;
        padding: 10px
    }
    
    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips differently */
    .d3-tip.n:after {
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
    }
    
    #information{
        text-align: center;
    }
    
    .container{width:100%;}
    .left{float:left;width:50%;}
    .right{float:right;width:50%;}
    
    .legend {
        position: absolute;
        top: 50px;
        left: 10px;
        z-index: 10;
    }
    
</style>

<body>
    <script src="lib/noUiSlider/nouislider.min.js"></script>
    <div>
        <div><img class='legend' src='legend.png' style="width: 200px;"></div>
        <div id="map">

        </div>
    </div>
    
    <div class="sliderDiv">
        <div id="slider-date"></div>
        <div>
            Begin Timeline: <span id="event-start"></span>
        </div>
        <div>
            End Timeline: <span id="event-end"></span>
        </div>
    </div>

    <div class="sliderDiv">
        <div id="picker-date"></div>
        <div id="current-date"></div>
    </div>
    
    <div>
        <h1 id="information">
            Station 36: NAME 
        </h1>
        
        <div class="container">
            <div id="chart1" class="left">
                <svg></svg>
            </div>

            <div id="chart2" class="right">
                <svg></svg>
            </div>
        </div>

        <div class="container">
            <div id="chart3" class="left">
                <svg></svg>
            </div>

            <div id="chart4" class="right">
                <svg></svg>
            </div>
        </div>

        <div class="container">
            <div id="chart5" class="left">
                <svg></svg>
            </div>

            <div id="chart6" class="right">
                <svg></svg>
            </div>
        </div>
    </div>
    
    <script>
        var datasets;
        var datasetLocation;
        var dates;
        var marker;
        var layer;
        var projection;
        var dates = [];
        
        //create the map
        var map = new google.maps.Map(d3.select("#map").node(), {
          zoom: 9,
          center: new google.maps.LatLng(37.76487, -122.41948),
          mapTypeId: google.maps.MapTypeId.TERRAIN
        });

        //data structures for the different graphs
        var tempGraph = {
                    title: "Temperature",
                    data: [],
                    width: 500,
                    height: 300,
                    left: 90,
                    target: '#chart3',
                    x_accessor: 'date',
                    y_accessor: 'val',
                    min_x: new Date('1993-01-01'),
                    max_x: new Date('2015-01-01'),
                    linked: true,
                    interpolate_tension: 1.0,
                    x_label: 'Time',
                    y_label: 'Â°C',
                };

       var oxyGraph = {
                    title: "Oxygen",
                    data: [],
                    width: 500,
                    height: 300,
                    left: 90,
                    target: '#chart2',
                    min_x: new Date('1993-01-01'),
                    max_x: new Date('2015-01-01'),
                    x_accessor: 'date',
                    y_accessor: 'val',
                    min_y: 1,
                    linked: true,
                    interpolate_tension: 1.0,
                    x_label: 'Time',
                    y_label: 'mg/l',
                };
        
       var chlorphaGraph = {
                    title: "Chlorophyl A.PHA",
                    data: [],
                    width: 500,
                    height: 300,
                    left: 90,
                    target: '#chart1',
                    min_x: new Date('1993-01-01'),
                    max_x: new Date('2015-01-01'),
                    min_y: 0.01,
                    missing_is_hidden: true,
                    x_accessor: 'date',
                    y_accessor: 'val',
                    linked: true,
                    interpolate_tension: 1.0,
                    x_label: 'A.PHA.',
                    y_label: 'mg/l',
        };
        
       var chlorGraph = {
                    title: "Chlorophyl",
                    data: [],
                    width: 500,
                    height: 300,
                    target: '#chart4',
                    min_x: new Date('1993-01-01'),
                    max_x: new Date('2015-01-01'),
                    min_y: 0.01,
                    missing_is_hidden: true,
                    x_accessor: 'date',
                    y_accessor: 'val',
                    linked: true,
                    interpolate_tension: 1.0,
                    x_label: 'Time',
                    y_label: 'mg/l',
        };
        


        var dateSlider = document.getElementById('slider-date');
        var pickerDate = document.getElementById('picker-date');
        
        var dateValues = [
            document.getElementById('event-start'),
            document.getElementById('event-end')
        ];
        
        
        //update the location data used in the map
        updateLocationData = function (date){
            for(station in datasetLocation){
                for(index in datasets[station].chlorpha){
                    //console.log(station, index);
                    if(date.getTime() <= datasets[station].chlorpha[index].date.getTime()){
                        //console.log(station)
                        datasetLocation[station].size = datasets[station].chlorpha[index].val;
                        break;
                    }
                }
            }
            updateOverlay();
        }

        //initialize the 2 handle time interval slider
        initDateSlider = function (){
            noUiSlider.create(dateSlider, {
                range: {
                    min: 0,
                    max: dates.length-1
                },
                behaviour: 'drag',
                connect: true,
                step: 1,
                start: [ 0, dates.length-1],

            });
            
            //initialize the 1 handle time slider
            noUiSlider.create(pickerDate, {
                range: {
                    min: 0,
                    max: dates.length-1
                },
                step: 1,
                start: 0,

            });
            
            //initialize the on update function 
            pickerDate.noUiSlider.on('update', function( values, handle ) {
                document.getElementById("current-date").innerHTML = "Selected Date: " + formatDate(dates[+values[handle]]);
                
                if (typeof marker !== 'undefined') {
                    updateLocationData(dates[+values[handle]]);
                }
                
                oxyGraph.markers = [{'date': dates[+values[handle]], 'label': 'Selected Date'}];
                chlorphaGraph.markers = [{'date': dates[+values[handle]], 'label': 'Selected Date'}];
                tempGraph.markers = [{'date': dates[+values[handle]], 'label': 'Selected Date'}];
                chlorGraph.markers = [{'date': dates[+values[handle]], 'label': 'Selected Date'}];
                MG.data_graphic(oxyGraph);
                MG.data_graphic(chlorphaGraph);
                MG.data_graphic(tempGraph);
                MG.data_graphic(chlorGraph);
            });
            
            //initialize the on update function 
            dateSlider.noUiSlider.on('update', function( values, handle ) {
                dateValues[handle].innerHTML = formatDate(dates[+values[handle]]);

                //left handle is moved (start time changes)
                if(handle == 0){
                    tempGraph.min_x = dates[+values[handle]];
                    oxyGraph.min_x = dates[+values[handle]];
                    chlorphaGraph.min_x = dates[+values[handle]];
                    chlorGraph.min_x = dates[+values[handle]];
                } 

                //right handle is moved (end time changes)
                if(handle==1){
                    tempGraph.max_x = dates[+values[handle]];
                    oxyGraph.max_x = dates[+values[handle]];
                    chlorphaGraph.max_x = dates[+values[handle]];
                    chlorGraph.max_x = dates[+values[handle]];
                }

                //update data 
                MG.data_graphic(tempGraph);
                MG.data_graphic(oxyGraph);
                MG.data_graphic(chlorphaGraph);
                MG.data_graphic(chlorGraph);

                //update second slider
                updateDatePicker(dateSlider.noUiSlider.get());
            });
        }
        
        //update the range of the single handle time slider after an update of the 
        updateDatePicker = function(values){
            pickerDate.noUiSlider.updateOptions({
                range: {
                    'min': Math.floor(values[0]),
                    'max': Math.floor(values[1])
                }
            });
        }
        
        //function which is called when a user clicks on a station in the map.
        function changeStation(t){
            document.getElementById("information").innerHTML = "Station " + t + ": " + datasetLocation[t].name;
            
            oxyGraph.data = datasets[t].oxygen;
            tempGraph.data = datasets[t].temperature;
            chlorphaGraph.data = datasets[t].chlorpha;
            chlorGraph.data = datasets[t].chlor;
            MG.data_graphic(oxyGraph);
            MG.data_graphic(tempGraph);
            MG.data_graphic(chlorphaGraph);
            MG.data_graphic(chlorGraph);
        }
        
        //initialize the tooltip for the map
        var tip = d3.tip()
          .attr('class', 'd3-tip')
          .offset([-10, 0])
          .html(function(d) {
            return "<strong>Station " + d.key + ":</strong> <span>" + d.value.name + "</span>";
          });
        
          function transform(d) {
            padding = 10;
            d = new google.maps.LatLng(d.value.coord[1], d.value.coord[0]);
            d = projection.fromLatLngToDivPixel(d);
            return d3.select(this)
                .style("left", (d.x - padding) + "px")
                .style("top", (d.y - padding) + "px");
            }
        
        //update function for the overlay
        function updateOverlay(){
            var padding = 10;

            marker = layer.selectAll("svg")
              .data(d3.entries(datasetLocation))
              .each(transform) // update existing markers
              .attr("class", "marker");
            
          marker.selectAll("circle").attr("r", function(d) {return 5 + 5 * d.value.size;})
              .attr("cx", padding)
              .attr("cy", padding)
              .style("fill", function(d) {return getChlorColor(d.value.size);})
              .on('mouseover', tip.show)
              .on('mouseout', tip.hide);
            
          marker.call(tip);
        }
        
        //draw the overlay
        function drawOverlay(){
            
          var padding = 10;
            
          marker = layer.selectAll("svg")
              .data(d3.entries(datasetLocation))
              .each(transform) // update existing markers
              .enter().append("svg")
              .each(transform)
              .attr("class", "marker");

          // Add a circle.
          marker.append("circle")
              .attr("r", function(d) {return 5 + 5 * d.value.size;})
              .attr("cx", padding)
              .attr("cy", padding)
              .style("fill", function(d) {return getChlorColor(d.value.size);})
              .on("click", function(d) {return changeStation(d.key);})
        };
        
        

        
        
        //load the location data
        d3.tsv("location.tsv", function(locData){
            var locationData = {};

            
            locData.forEach(function(d){
               locationData[d["Station.Number"]] = {name:d["General.Location"], coord:[-d["West.Longitude"]/1000,+d["North.Latitude"]/1000], size: +d["Size"]};
            });
            
            //console.log(locationData);
                            
            //load the json with the data
            d3.json("data.json", function(error, stationData) {
                dataByStation = stationData[0];
                dates = stationData[1].dates;
                    
                for(station in dataByStation){
                    for(series in dataByStation[station]){
                        for(pair in dataByStation[station][series]){
                            dataByStation[station][series][pair].date = new Date(dataByStation[station][series][pair].date);
                        }
                    }
                }
                
                //create date objects
                for(index in dates){
                    dates[index] = new Date(dates[index]);
                }
                
                //store the datasets as global variables
                datasets = dataByStation;
                datasetLocation = locationData;
                
                
                //create the overlay
                var overlay = new google.maps.OverlayView();
                overlay.onAdd = function() {
                    layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
                        .attr("class", "stations");

                    //on draw function
                    overlay.draw = function() {
                      projection = this.getProjection();
                        
                      drawOverlay();
                      //populate overlay with initial data
                      updateLocationData(new Date("1993"));
                    };
                };

                overlay.setMap(map);
                
                //populate visualization with initial data of station 30
                initDateSlider(dates);
                changeStation("30");
            });
        });
    </script>
</body>
</html>